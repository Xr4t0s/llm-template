services:
  frontend:
    build: ./apps/frontend
    expose:
      - "3000"
    depends_on:
      - backend
    networks:
      - common

  backend:
    build: ./apps/backend
    ports:
      - "3001:3001" # Remap for testing api
    environment:
      - MCP_BASE_URL=${MCP_BASE_URL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    networks:
      - common

  n8n:
    image: n8nio/n8n:latest
    container_name: llm-n8n
    restart: unless-stopped

    ports:
      - "5678:5678" # optionnel, utile pour debug / accès direct

    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=adminpassword

      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http

      - N8N_EDITOR_BASE_URL=http://localhost/n8n
      - WEBHOOK_URL=http://localhost/n8n/

      # ⚠️ IMPORTANT pour l'import auto
      - N8N_IMPORT_EXPORT_DIR=/workflows

      # évite le tracking
      - N8N_DIAGNOSTICS_ENABLED=false

      - N8N_RESTRICT_FILE_ACCESS_TO=/data/shared
      - N8N_RUNNERS_HEARTBEAT_INTERVAL=360
      - NODE_FUNCTION_ALLOW_BUILTIN=crypto,fs
    volumes:
      - ./n8n/data:/home/node/.n8n
      - ./n8n/workflows:/workflows
      - ./shared:/data/shared

    networks:
      - llm-network

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: llm-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      # - "443:443"  # Uncomment for HTTPS later
    volumes:
      - ./nginx/nginx-http.conf:/etc/nginx/nginx.conf:ro
      # - ./nginx/ssl-params.conf:/etc/nginx/ssl-params.conf:ro
      # - ./certbot/conf:/etc/letsencrypt:ro
      # - ./certbot/www:/var/www/certbot:ro
      - nginx-logs:/var/log/nginx
    networks:
      - llm-network
      - common
    depends_on:
      - frontend
      - backend
      - mcp-docs
      - mcp-website
      - mcp-visuals

  # Certbot (commented for HTTP testing)
  # certbot:
  #   image: certbot/certbot:latest
  #   container_name: llm-certbot
  #   volumes:
  #     - ./certbot/conf:/etc/letsencrypt
  #     - ./certbot/www:/var/www/certbot
  #   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
  #   networks:
  #     - llm-network

  # Placeholder MCP servers
  mcp-docs:
    build: ./mcp-servers/mcp-documentation
    container_name: mcp-docs
    restart: unless-stopped
    ports:
      - "8000"
    environment:
      - SERVER_NAME=documentation
    networks:
      - llm-network

  mcp-website:
    image: python:3.12-slim
    container_name: mcp-website
    command: python -m http.server 8002
    networks:
      - llm-network

  mcp-visuals:
    image: python:3.12-slim
    container_name: mcp-visuals
    command: python -m http.server 8003
    networks:
      - llm-network

volumes:
  nginx-logs:

networks:
  common:
    driver: bridge
  llm-network:
    driver: bridge